!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){window.clearTimeout(a)})}();var _={},$={},idCounter=0;_.uniqueId=function(a){var b=++idCounter+"";return a?a+b:b},_.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},_.extend=function(a){if(!_.isObject(a))return a;for(var b,c,d=1,e=arguments.length;e>d;d++){b=arguments[d];for(c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a},_.pad=function(a,b){var c="0000000"+a;return c.substr(c.length-b)},$.Base=function(a){_.isObject(a)&&_.extend(this,a||{}),this.cid=_.uniqueId("c"),this.start.apply(this,arguments)},_.extend($.Base.prototype,{start:function(){}}),$.Base.extend=function(a,b){var c=this,d=function(){return c.apply(this,arguments)};_.extend(d,c,b);var e=function(){this.constructor=d};return e.prototype=c.prototype,d.prototype=new e,a&&_.extend(d.prototype,a),d._super=c.prototype,d},$.Entity=$.Base.extend({pos:{x:0,y:0},start:function(){},update:function(){},draw:function(){}}),$.Collection=$.Base.extend({entities:[],start:function(){this.entities=[]},update:function(){this.entities.forEach(function(a){a.update()})},draw:function(a){this.entities.forEach(function(b){b.draw(a)})}}),$.M=$.Base.extend({},{rnd:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},rnd01:function(){return Math.random()},rndInCircle:function(a){var b=Math.random()*Math.PI*2,c=$.M.rnd(0,a);return{x:Math.cos(b)*c,y:Math.sin(b)*c}},lerp:function(a,b,c){return(1-c)*a+c*b},polygonPoints:function(a,b,c){for(var d=[],e=2*Math.PI/c,f=0;c>f;f++)d.push({x:a.x+b*Math.cos(f*e),y:a.y+b*Math.sin(f*e)});return d}}),$.C=$.Base.extend({},{white:[255,255,255,1],toRGBA:function(a){return"rgba("+a[0]+","+a[1]+","+a[2]+","+(a[3]||1)+")"},lerp:function(a,b,c){function d(a,b,c,d){return d=d?d:1,Math.round($.M.lerp(a,b,c)*d)/d}return[d(a[0],b[0],c),d(a[1],b[1],c),d(a[2],b[2],c),d(a[3]>=0?a[3]:1,b[3]>=0?b[3]:1,c,100)]},eql:function(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}}),$.V=$.Base.extend({},{zero:{x:0,y:0},one:{x:1,y:1},clone:function(a){return{x:a.x,y:a.y}},prod:function(a,b){return{x:a.x*b.x,y:a.y*b.y}},multiply:function(a,b){return{x:a.x*b,y:a.y*b}},divide:function(a,b){return{x:a.x/b,y:a.y/b}},add:function(a,b){return{x:a.x+b.x,y:a.y+b.y}},dif:function(a,b){return{x:b.x-a.x,y:b.y-a.y}},part:function(a,b,c){return $.V.lerp(a,b,c/10)},angleTo:function(a,b){var c=$.V.dif(a,b);return Math.atan2(c.y,c.x)},mid:function(a,b){return $.V.divide($.V.add(a,b),2)},eql:function(a,b){return a.x===b.x&&a.y===b.y},normal:function(a,b){var c=$.V.dif(a,b),d=$.V.magnitude(a,b);return{x:c.x/d||0,y:c.y/d||0}},origin:function(a,b){return{x:a.x-b.x/2,y:a.y-b.y/2}},center:function(a,b){return{x:a.x+b.x/2,y:a.y+b.y/2}},magnitude:function(a,b){var c=$.V.dif(a,b);return Math.sqrt(c.x*c.x+c.y*c.y)},pointInCircle:function(a,b,c){return $.V.magnitude(a,b)<c},lerp:function(a,b,c){return{x:a.x+(b.x-a.x)*c,y:a.y+(b.y-a.y)*c}},round:function(a){return a.x=Math.round(a.x),a.y=Math.round(a.y),a},isOut:function(a,b,c){return a.x<b.x||a.x>c.x||a.y<b.y||a.y>c.y}}),$.Renderer=$.Base.extend({},{fill:function(a,b){b.hasOwnProperty("fill")&&(a.fillStyle=b.fill,a.fill())},stroke:function(a,b){if(b.hasOwnProperty("stroke")){a.lineWidth=b.strokeWidth||b.stroke.size||1;var c=b.stroke.color||b.stroke||"#000";a.strokeStyle=Array.isArray(c)?$.C.toRGBA(c):c,a.stroke()}},_drawRect:function(a,b){a.beginPath(),a.rect(b.pos.x,b.pos.y,b.size.x,b.size.y),$.Renderer.fill(a,b),$.Renderer.stroke(a,b)},drawCircle:function(a,b){var c=b.angles&&b.angles.start||0,d=b.angles&&b.angles.end||2*Math.PI;a.beginPath(),b.lineCap&&(a.lineCap=b.lineCap),a.arc(b.pos.x,b.pos.y,b.radius,c,d,!1),$.Renderer.fill(a,b),$.Renderer.stroke(a,b)},drawLine:function(a,b){var c=b.from,d=b.to;a.beginPath(),a.lineCap="round",a.moveTo(c.x,c.y),a.lineTo(d.x,d.y),a.lineWidth=b.size,a.strokeStyle=b.color,a.stroke()},drawSprite:function(a,b){function c(){j?a.drawImage(d,j.x,j.y,j.w,j.h,f,g,h,i):a.drawImage(d,f,g,h,i)}var d=$.repo[b.resource],e=$.V.origin(b.pos,b.size),f=e.x,g=e.y,h=b.size.x,i=b.size.y,j=b.sp;return b.hasOwnProperty("angle")?(a.save(),a.translate(f+h/2,g+i/2),f=-h/2,g=-i/2,a.rotate(b.angle),c(),void a.restore()):void c()},drawText:function(a,b){a.font=b.size+"pt Arial",a.textBaseline=b.baseline||"middle",a.fillStyle=b.color,a.fillText(b.text,b.pos.x,b.pos.y)},drawRect:function(a,b){var c=b.pos.x,d=b.pos.y,e=b.size.x,f=b.size.y;if(!b.hasOwnProperty("corner"))return void $.Renderer._drawRect(a,b);var g=b.corner;a.beginPath(),a.moveTo(c+g,d),a.lineTo(c+e-g,d),a.quadraticCurveTo(c+e,d,c+e,d+g),a.lineTo(c+e,d+f-g),a.quadraticCurveTo(c+e,d+f,c+e-g,d+f),a.lineTo(c+g,d+f),a.quadraticCurveTo(c,d+f,c,d+f-g),a.lineTo(c,d+g),a.quadraticCurveTo(c,d,c+g,d),a.closePath(),$.Renderer.fill(a,b),$.Renderer.stroke(a,b)}}),$.Circle=$.Entity.extend({pos:{x:0,y:0},radius:5,stroke:null,start:function(){},update:function(){},draw:function(a){var b={pos:this.pos,radius:this.radius,lineCap:this.lineCap||"butt"};this.color&&(b.fill=$.C.toRGBA(this.color)),this.stroke&&(b.stroke=this.stroke),this.angles&&(b.angles=this.angles),$.Renderer.drawCircle(a,b)}}),$.Line=$.Entity.extend({pos:{x:0,y:0},to:{x:0,y:0},size:1,color:$.C.white,start:function(){},update:function(){},draw:function(a){$.Renderer.drawLine(a,{from:this.pos,to:this.to,size:this.size,color:$.C.toRGBA(this.color)})}}),$.Rect=$.Entity.extend({pos:{x:0,y:0},size:{x:20,y:20},fill:null,stroke:null,corner:null,start:function(){},update:function(){},draw:function(a){var b={pos:this.pos,size:this.size};this.stroke&&(b.stroke=this.stroke,b.stroke.color&&(b.stroke.color=$.C.toRGBA(b.stroke.color))),this.fill&&(b.fill=$.C.toRGBA(this.fill)),this.corner&&(b.corner=this.corner),$.Renderer.drawRect(a,b)}}),$.Text=$.Entity.extend({pos:{x:0,y:0},text:"",size:1,color:$.C.white,start:function(){},update:function(){},draw:function(a){var b={text:this.text,pos:this.pos,size:this.size,color:$.C.toRGBA(this.color)};$.Renderer.drawText(a,b)}}),$.Sprite=$.Entity.extend({resource:"",pos:{x:0,y:0},size:{x:20,y:20},start:function(){},update:function(){},draw:function(a){var b={resource:this.resource,pos:this.pos,size:this.size};this.sprite&&(b.sp=this.sprite),this.angle&&(b.angle=this.angle),$.Renderer.drawSprite(a,b)}}),$.Controls=$.Base.extend({events:{pressing:null,moving:null,release:null,element:null,pause:null},enabled:!1,start:function(a){var b=window.document,c=this.container=a.container||b;c.onmouseup=this._onMouseEvent.bind(this,"release"),c.onmousedown=this._onMouseEvent.bind(this,"pressing"),c.onmousemove=this._onMouseEvent.bind(this,"moving"),b.onkeyup=this._onKeyUp.bind(this)},enable:function(){return this.enabled=!0,this},disable:function(){return this.enabled=!1,this},on:function(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b),this},off:function(a){return this.events[a]&&(this.events[a].length=0),this},_getEventName:function(a){switch(a.which||a.keyCode){case 81:case 113:return"element:fire";case 87:case 119:return"element:water";case 69:case 101:return"element:earth";case 82:case 114:return"element:air";case 112:case 80:return"pause"}},_onKeyUp:function(a){var b=this._getEventName(a);if((this.enabled||"pause"===b)&&b){if(b.indexOf("element")>-1){var c=b.split(":")[1];return void this.events.element.forEach(function(a){a(c)})}this.events[b].forEach(function(a){a()})}},_onMouseEvent:function(a,b){if(this.enabled){var c=this.getCoordsEvent(b,this.container);this.events[a].forEach(function(a){a(c)})}},getCoordsEvent:function(a,b){var c,d,e=document,f=e.body,g=e.documentElement;return a.pageX||a.pageY?(c=a.pageX,d=a.pageY):(c=a.clientX+f.scrollLeft+g.scrollLeft,d=a.clientY+f.scrollTop+g.scrollTop),c-=b.offsetLeft,d-=b.offsetTop,{x:c,y:d}}}),$.Node=$.Circle.extend({radius:3,color:$.C.white,nears:null,selected:!1,temp:0,incTemp:0,incTempSize:0,burned:!1,shaked:!1,originalPos:null,hasEarth:!1,insideTarget:!1,blowing:!1,blowingEnd:0,colors:{cold:[255,255,255,1],burn:[255,0,0,1],burned:[0,0,0,.2],earth:[190,160,40,1]},start:function(){this.nears=[]},addNear:function(a){this.nears.push(a)},randomBurn:function(){var a=this.nears.some(function(a){return a.burned});!a&&$.M.rnd01()<.15&&this.setBurned()},getNearBurned:function(){var a;return this.nears.some(function(b){return b.burned?(a=b,!0):void 0}),a},shake:function(){this.originalPos?this.pos=this.originalPos:this.originalPos=this.pos,this.shaked=!0,this.pos=$.V.round($.V.add(this.pos,$.M.rndInCircle(.2)))},endShake:function(){this.originalPos&&(this.pos=this.originalPos),this.shaked=!1},revive:function(){this.burned&&(this.resetTemp(),this.burned=!1)},burn:function(){this.burned||(this.incTemp=1)},cool:function(){this.burned||(this.incTemp=-1,this.incTempSize=.5)},dirty:function(){this.burned||(this.hasEarth=!0)},blow:function(){this.burned||(this.blowing=!0,this.hasEarth=!1,this.blowingEnd=Time.time+500)},getRandomNear:function(a){var b=[];if(this.nears.forEach(function(c){c.cid!==a&&!c.burned&&c.temp<.5&&b.push(c)}),b.length>0){var c=$.M.rnd(0,b.length-1);return b[c]}return null},resetTemp:function(){this.temp=0,this.incTemp=0,this.incTempSize=0},setBurned:function(){this.burned=!0,this.fill=this.color=this.colors.burned,this.resetTemp()},update:function(){if(!this.burned){if(this.blowing&&Time.time>this.blowingEnd&&(this.blowing=!1),this.hasEarth)return this.fill=this.color=this.colors.earth,void this.resetTemp();var a=this.nears.every(function(a){return a.burned});return a?void this.setBurned():(this.incTemp>0&&(this.incTempSize=this.blowing?.2:.1),this.blowing||this.insideTarget?this.shake():this.shaked&&this.endShake(),this.temp+=this.incTemp*this.incTempSize*Time.deltaTime,this.temp<=0&&this.resetTemp(),this.fill=this.color=$.C.lerp(this.colors.cold,this.colors.burn,this.temp),this.temp>1?(this.setBurned(),void this.resetTemp()):void 0)}}}),$.Nodes=$.Collection.extend({paths:null,applyPos:null,applyRatio:0,element:null,start:function(){this.paths=new $.Paths;var a=config.world.margin.x,b=config.world.margin.y,c=$.V.divide(config.size,2);c.x-=a,c.y-=b;var d=$.V.center($.V.zero,config.size);this.createWeb(d,c)},createWeb:function(a,b){var c=0,d=30,e=d/5,f=6,g=3,h=2,i=8*f,j=$.V.add(a,$.V.multiply(b,-1)),k=$.V.add(a,b),l=[],m=new $.Node({pos:a});this.entities.push(m);var n,o=10,p=1,q=0;do{n=!1,p%g===0&&(f*=h),f>i&&(f=i);var r=$.M.polygonPoints(a,p*d+o,f);q+=r.length;var s=[];(10===p||20===p)&&(e+=.1),r.forEach(function(a){var b=$.V.round($.V.add(a,$.M.rndInCircle(e))),c=new $.Node({pos:b});$.V.isOut(b,j,k)?c.out=!0:(n=!0,this.entities.push(c)),s.push(c)},this),l[p-1]=s,p++}while(n);c=p-2,l[0].forEach(function(a){this.paths.addOne(m,a)},this);var t,u,v,w;for(t=0;c>t;t++){var x=l[t],y=x.length;for(u=0;y>u;u++){v=u+1,w=u*h,v>y-1&&(v=0),w>y*h-g&&(w=-h);var z=l[t][v];if(!z.out){var A=l[t+1],B=A[v];A.length>x.length&&(B=A[w+h]),c-1>t&&B&&!B.out&&this.paths.addOne(z,B);var C=l[t][u];C.out||this.paths.addOne(z,C)}}}this.entities.forEach(function(a){a.randomBurn()})},findNodeByCollider:function(){var a=config.elements,b=config.methods;this.entities.forEach(function(c){this.applyPos&&$.V.pointInCircle(this.applyPos,c.pos,this.applyRatio)&&c[b[a.indexOf(this.element)]]()},this)},getNodes:function(){return this.entities},update:function(){this.applyPos&&this.findNodeByCollider(),this.paths.update(),$.Nodes._super.update.apply(this)},draw:function(a){this.paths.draw(a),$.Nodes._super.draw.apply(this,arguments)}}),$.Path=$.Line.extend({pos:{x:0,y:0},to:{x:0,y:0},size:2,color:$.C.white,tBurn:.5,burned:!1,heat:null,na:null,nb:null,setHeat:function(a,b,c){this.heat={from:a.pos,to:$.V.round($.V.lerp(a.pos,b.pos,2*c>1?1:2*c))}},update:function(){var a=this.na,b=this.nb,c=a.temp,d=b.temp,e=a.color,f=this.nb.color;c>0?this.setHeat(a,b,c):d>0&&this.setHeat(b,a,d),c>this.tBurn&&0===d?b.burn():d>this.tBurn&&0===c&&a.burn(),this.color=$.C.eql(e,f)?e:$.C.lerp(e,f,this.tBurn),(a.burned||b.burned)&&(this.heat=null,this.burned=!0,this.color=[0,0,0,.2]),this.pos=this.na.pos,this.to=this.nb.pos},draw:function(a){$.Path._super.draw.apply(this,arguments),this.heat&&$.Renderer.drawLine(a,{from:this.heat.from,to:this.heat.to,size:5,color:"rgba(255,0,0,0.4)"})}}),$.Paths=$.Collection.extend({hasOne:function(a,b){return this.entities.some(function(c){var d=c.na.cid,e=c.nb.cid;return!(a!==d&&a!==e||b!==d&&b!==e)})},addOne:function(a,b){b&&!this.hasOne(a.cid,b.cid)&&(a.addNear(b),b.addNear(a),this.entities.push(new $.Path({na:a,nb:b})))}}),$.Cursor=$.Circle.extend({radius:20,stroke:{color:"#fff",size:2},active:!1,element:"fire",start:function(){Controls.on("pressing",this.onPressing.bind(this)),Controls.on("moving",this.onMoving.bind(this)),Controls.on("release",this.onRelease.bind(this)),Controls.on("element",this.onElement.bind(this))},onPressing:function(a){this.pos=a,this.active=!0},onMoving:function(a){this.pos=a},onRelease:function(){this.active=!1},onElement:function(a){this.element=a},update:function(){var a=config.elements,b=.4,c=[20,20,20,50],d=[[255,0,0,b],[0,0,255,b],[165,140,80,b],[0,220,255,b]];this.color=d[a.indexOf(this.element)],this.radius=c[a.indexOf(this.element)]}}),$.Spider=$.Sprite.extend({resource:"spider",size:{x:32,y:32},nFrom:null,nTo:null,journeyLength:null,traveling:!1,isDead:!1,temp:0,staying:!1,t_stay:2e3,t_startStay:0,t_nextStay:0,t_startMove:0,building:!1,spriteIndex:0,animTime:3,lastFrameTime:0,exited:!1,calmSpeed:.05,alertSpeed:.1,behaviour:{alertTemp:0,tStayA:3e3,tStayB:1e4},start:function(a){this.pos=$.V.round(a.pos),this.onDead=a.onDead,this.speed=this.calmSpeed,this.move=[];for(var b=0;3>b;b++)this.move.push({x:32*b,y:0,w:32,h:32});this.sprite=this.move[0]},setNode:function(a,b){this.nFrom=a,this.nTo=b,this.t_startMove=Time.time,this.journeyLength=$.V.magnitude(a.pos,b.pos),this.traveling=!0,this.angle=$.V.angleTo(this.pos,this.nTo.pos)},setDead:function(){this.isDead||(this.isDead=!0,this.onDead())},burn:function(){this.setDead()},animate:function(){this.staying||(this.lastFrameTime-=Time.frameTime,this.lastFrameTime<=0&&(this.spriteIndex++,this.spriteIndex>2&&(this.spriteIndex=0),this.lastFrameTime=this.animTime/this.speed))},updateTemp:function(){var a=this.nFrom,b=this.nTo,c=a.temp,d=b.temp,e=a.blowing,f=a.blowing;return e||f?void(this.temp=.1):0===c&&0===d?void(this.temp=0):c>d?void(this.temp=c):void(d>c&&(this.temp=d))},canMove:function(){return!this.staying&&!this.traveling&&!this.building},updateState:function(){var a=Time.time,b=this.behaviour,c=this.t_startStay,d=this.t_stay;return this.temp>b.alertTemp?(this.speed=this.alertSpeed,void(this.staying=!1)):(this.speed=this.calmSpeed,void(this.staying?a>c+d&&(this.staying=!1,this.t_nextStay=a+d/$.M.rnd(2,5)):a>this.t_nextStay&&$.M.rnd01()<.8&&(this.staying=!0,this.t_startStay=a,this.t_stay=$.M.rnd(b.tStayA,b.tStayB))))},updateMove:function(){if(!this.building&&(this.nFrom.burned||this.nTo.burned))return void this.setDead();var a=(Time.time-this.t_startMove)*this.speed,b=a/this.journeyLength;return b>1?(this.pos=this.nTo.pos,this.nTo.revive(),this.traveling=!1,this.building=!1,!0):(this.pos=$.V.round($.V.lerp(this.nFrom.pos,this.nTo.pos,b)),void this.animate())},buildWeb:function(a,b){this.building=!0,this.traveling=!0,this.setNode(a,b)},update:function(){if(this.sprite=this.move[this.spriteIndex],!(this.isDead||this.exited||this.inVacuum)){if(this.updateTemp(),this.building||this.traveling){var a=this.updateMove();if(!a)return}this.updateState()}},draw:function(a){this.isDead||(this.building&&$.Renderer.drawLine(a,{from:this.pos,to:this.nFrom.pos,size:2,color:$.C.toRGBA($.C.white)}),$.Spider._super.draw.apply(this,arguments))}}),$.Spiders=$.Collection.extend({nodes:null,spidersExit:0,spidersKilled:0,stats:{},amount:50,applyPos:null,applyRatio:0,element:null,start:function(a){this.entities=[],this.nodes=a.nodes,this.onExitSpider=a.onExitSpider,this.generateSpiders(),this.updateGUI()},updateGUI:function(){this.stats={saved:this.spidersExit,killed:this.spidersKilled,alives:this.entities.length-(this.spidersKilled+this.spidersExit),total:this.entities.length}},onSpiderDead:function(){this.spidersKilled++,this.updateGUI()},generateSpiders:function(){var a,b,c=this.nodes.getNodes(),d=c.length,e=[],f=d<this.amount?d-2:this.amount;do b=$.M.rnd(0,d-1),a=c[b],a.burned||-1!==e.indexOf(a.cid)||(e.push(a.cid),this.entities.push(new $.Spider({pos:a.pos,onDead:this.onSpiderDead.bind(this)})),f--);while(f)},getSpiders:function(){return this.entities},gonnaBuildWeb:function(a,b){if(!a.hasEarth&&0===a.temp&&$.M.rnd01()>.7){var c=a.getNearBurned();if(c)return b.buildWeb(a,c),!0}return!1},gotNearNodeToGo:function(a,b){var c=b.nodeFrom&&b.nodeFrom.cid||-1,d=a.getRandomNear(c);return d?(b.setNode(a,d),!0):!1},spiderNodeCollide:function(a,b){$.V.pointInCircle(a.pos,b.pos,5)&&(this.gonnaBuildWeb(b,a)||this.gotNearNodeToGo(b,a)||b.burned&&a.setDead())},findSpidersByCollider:function(){var a=config.elements,b=config.methods;this.entities.forEach(function(c){this.applyPos&&$.V.pointInCircle(this.applyPos,c.pos,this.applyRatio)&&c[b[a.indexOf(this.element)]]()},this)},update:function(){this.applyPos&&"fire"===this.element&&this.findSpidersByCollider();var a=this.nodes.getNodes(),b=this.spidersExit;this.spidersExit=0,this.entities.forEach(function(b){b.exited?this.spidersExit++:b.canMove()&&a.some(function(a){this.spiderNodeCollide(b,a)},this),b.update()},this),b!==this.spidersExit&&this.updateGUI()},draw:function(a){this.entities.forEach(function(b){b.inVacuum||b.draw(a)})}}),$.Target=$.Circle.extend({stroke:{color:[80,255,85,.1]},angles:{start:.97*Math.PI,end:1.52*Math.PI},lineCap:"butt",suckForce:3,start:function(){var a=config,b=a.world.margin;this.size=a.size.y/6,this.radius=this.size/2,this.stroke.size=this.size,this.pos=$.V.prod($.V.one,a.size),this.pos.x-=b.x+10,this.pos.y-=b.y+20,this.saved=[],this.saving=[]},setNodesInside:function(a){a.forEach(function(a){$.V.pointInCircle(a.pos,this.pos,this.size)&&(a.burned&&(a.burned=!1,a.revive()),a.insideTarget=!0)},this)},update:function(a){a.forEach(function(a){a.dead||a.exited||$.V.pointInCircle(a.pos,this.pos,this.size)&&(a.building=!1,a.exited=!0,a.vel={x:0,y:0},this.saving.push(a))},this);var b=Time.deltaTime,c=b*this.suckForce,d=this.pos;this.saving.forEach(function(a){if(!a.catched){var b=a.pos,e=$.V.normal(b,d);a.vel=$.V.add(a.vel,$.V.multiply(e,c)),a.pos=$.V.add(b,a.vel),$.V.pointInCircle(a.pos,d,5)&&(a.catched=!0,this.saved.push(a))}},this)}}),$.Vacuum=$.Entity.extend({start:function(a){this.target=a.target,this.size=config.vacuum.size,this.targetLen=20,this.current=0,this.offx=30,this.offy=10,this.recipePos={x:this.offx+165,y:this.offy+65},this.recipeSize={x:80,y:300},this.createGraphics()},createGraphics:function(){var a=$.sprites.vacuum.size;this.bgBack=new $.Sprite({resource:"vacuum",pos:$.V.center({x:this.offx,y:this.offy},a),size:a});var b=[187,187,249],c={pos:this.recipePos,size:this.recipeSize,corner:6,fill:$.C.white,stroke:{size:2,color:b}};this.cilinder=new $.Rect(c),c.fill=[0,0,255,.5],this.glass=new $.Rect(c),this.stats=new $.Text({pos:{x:180,y:30},size:20,color:$.C.white})},update:function(){this.current=this.target.saved.length;var a=this.recipePos,b=this.recipeSize,c=a.y+b.y/2,d=a.x+b.x/2,e=2*Time.time*Math.PI;this.target.saved.forEach(function(a){if(a.inVacuum){a.animate();var b=a.vacuum;a.pos={x:b.ampX*Math.sin(e/b.velX)+d,y:b.ampY*Math.sin(e/b.velY)+c},a.angle+=b.rot}else a.inVacuum=!0,a.vacuum={ampY:$.M.rnd(10,c/2),velY:$.M.rnd(600,1e3),ampX:$.M.rnd(5,20),velX:$.M.rnd(2e3,6e3),rot:$.M.rnd(1,5)/10},a.pos={x:d,y:c}},this),this.stats.text=_.pad(this.current,3)+" / "+_.pad(this.targetLen,3)},draw:function(a){this.bgBack.draw(a),this.cilinder.draw(a),this.target.saved.forEach(function(b){b.draw(a)}),this.glass.draw(a),this.stats.draw(a)}}),$.Stats=$.Collection.extend({pos:{x:1,y:0},marginW:40,marginH:40,colors:{kills:[255,0,0,1],alives:[0,255,0,1]},start:function(){this.entities=[],this.pos=$.V.prod(this.pos,config.size),this.stats={saved:0,killed:0,alives:0,total:0},this.createIcons(),this.createText()},createIcons:function(){var a=40,b=this.marginW,c=this.marginH,d={x:a,y:a},e={x:a/2,y:a/2},f={resource:"spider",sprite:{x:0,y:0,w:32,h:32},size:d,angle:Math.PI/2};f.pos={x:this.pos.x-b,y:this.pos.y+c+1.5*a},this.iconAlives=new $.Sprite(f),this.entities.push(this.iconAlives),f.pos={x:this.pos.x-b,y:this.pos.y+c},this.iconKills=new $.Sprite(f),this.entities.push(this.iconKills),this.lineAKills=new $.Line({pos:$.V.origin(f.pos,d),to:$.V.add(e,f.pos),size:3,color:this.colors.kills}),this.entities.push(this.lineAKills),this.lineBKills=new $.Line({pos:{x:f.pos.x+e.x,y:f.pos.y-e.y},to:{x:f.pos.x-e.x,y:f.pos.y+e.y},size:3,color:this.colors.kills}),this.entities.push(this.lineBKills)},createText:function(){var a=30;this.textKills=new $.Text({pos:{x:this.iconKills.pos.x-3*a,y:this.iconKills.pos.y},size:a,color:this.colors.kills}),this.entities.push(this.textKills),this.textAlives=new $.Text({pos:{x:this.iconAlives.pos.x-3*a,y:this.iconAlives.pos.y},size:a,color:this.colors.alives}),this.entities.push(this.textAlives)},update:function(a){this.stats=a,this.textKills.text=_.pad(this.stats.killed,3),this.textAlives.text=_.pad(this.stats.alives,3)}}),$.Element=$.Collection.extend({size:{x:96,y:96},start:function(a){this.entities=[],this.name=a.name,this.key=a.key,this.showKeys=a.showKeys,this.color=[255,255,255,.1],this.sprite=a.sprite,this.active=!1,this.current=!1,this.createElement()},createElement:function(){var a=this.size,b=this.pos;this.bg=new $.Rect({pos:b,size:a,fill:this.color,stroke:{size:4,color:[30,30,30,1]},corner:8}),this.entities.push(this.bg),this.icon=new $.Sprite({resource:"elements",pos:$.V.center({x:b.x+3,y:b.y+6},{x:a.x-6,y:a.y-6}),size:a,angle:0,sprite:this.sprite}),this.entities.push(this.icon);var c={x:b.x,y:b.y+1.1*a.y},d=20;this.showKeys&&(this.ctrlKey=new $.Rect({pos:{x:c.x-d/2,y:c.y-d},size:$.V.multiply($.V.one,2*d),fill:[0,0,0,1],corner:4}),this.entities.push(this.ctrlKey),this.txtKey=new $.Text({text:this.key,pos:c,size:d,color:[255,255,255,1]}),this.entities.push(this.txtKey))},update:function(){this.bg.fill=this.active?[255,255,255,1]:[255,255,255,.1],this.bg.stroke.color=this.current?[255,255,255,1]:[0,0,0,1]}}),$.Elements=$.Collection.extend({pos:{x:20,y:50},size:96,gap:50,showKeys:!0,start:function(){this.entities=[],this.current="fire",this.active=!1,this.keys=["Q","W","E","R"],this.elements=config.elements,this.sprites={};for(var a=0;4>a;a++)this.sprites[this.elements[a]]={x:32*a,y:0,w:32,h:32};this.createElements()},createElements:function(){var a=this.gap,b=this.size,c=this.showKeys;this.elements.forEach(function(d,e){this.entities.push(new $.Element({pos:{x:this.pos.x,y:this.pos.y+e*(b+a)},size:{x:b,y:b},name:d,key:this.keys[e],sprite:this.sprites[d],showKeys:c}))},this)},update:function(){var a=this.active,b=this.current;this.entities.forEach(function(c){c.active=c.current=!1,c.name===b&&(c.current=!0,c.active=a),c.update()})}}),$.sprites={color:"b9ce5a",spider:[[,,,,,,,,,,,,,,,],[,,,,,,,,,,,,,,,],[,,,,7,,3,,3,,7,,,,,],[,,1,,7,1,3,,3,1,7,3,7,,,],[,7,3,1,,,1,,1,,3,7,3,7,,],[2,4,3,,1,,1,,1,,1,,,3,7],[,4,3,,,1,1,1,1,1,,,,3,2],[,,,,1,1,1,1,1,1,1,1,,3,2],[,3,2,,1,1,1,1,1,1,1,1,,4,,],[,3,2,,,1,1,1,1,1,,,,4,3],[4,3,2,,1,,1,,1,,1,,,4,3],[,4,3,1,,,1,,1,,3,1,,6,,2],[,,,3,1,7,3,3,3,7,7,,1,,2],[,,,,7,,3,,3,,7,,,2,,],[,,,,,,,,,,,,,,,],[,,,,,,,,,,,,,,,]],colors:[[,"ff1414","ffc700","fff600"],[,"5481ce","5cb1f2","90e3f9"],[,"966910","bf8f35"],[,"aed7ef","e3f9fc"]],elements:[[[,,,,,,,1,1,,,,,,,],[,,,,,,1,1,1,1,,,,,,],[,,,,,,1,1,1,1,1,,,,,],[,,,,,1,1,1,2,1,1,,,,,],[,,,1,,1,1,2,2,1,1,,,,,],[,,1,1,,1,1,2,2,1,1,,1,,,],[,1,1,1,,1,1,2,2,1,1,,1,1,,],[,1,1,1,,1,1,2,2,1,1,,1,1,1],[,1,2,1,1,1,1,2,2,1,1,,1,1,1],[,1,2,2,1,1,2,2,2,2,1,1,1,2,1],[,1,2,2,2,2,2,3,3,2,2,2,2,2,1],[,1,2,2,3,3,2,3,3,2,3,3,2,2,1],[,1,1,2,2,3,3,3,3,3,3,2,2,1,1],[,,1,1,2,2,3,3,3,2,2,2,1,1,,],[,,,1,1,2,2,2,2,2,2,1,1,,,],[,,,,1,1,1,1,1,1,1,1,,,,]],[[,,,,,,,1,1,,,,,,,],[,,,,,,,1,1,,,,,,,],[,,,,,,1,1,1,1,,,,,,],[,,,,,,1,1,1,1,,,,,,],[,,,,,1,1,1,2,1,1,,,,,],[,,,,1,1,1,2,2,1,1,1,,,,],[,,,,1,1,2,2,2,2,1,1,1,,,],[,,,1,1,2,2,2,2,3,2,1,1,,,],[,,1,1,2,2,2,2,3,3,3,2,1,1,,],[,,1,1,2,2,2,2,2,3,3,2,1,1,,],[,,1,1,2,2,2,2,2,2,2,2,1,1,,],[,,1,1,2,2,2,2,2,2,2,2,1,1,,],[,,1,1,2,2,2,2,2,2,2,2,1,1,,],[,,1,1,1,2,2,2,2,2,2,1,1,,,],[,,,1,1,1,1,1,1,1,1,1,,,,],[,,,,1,1,1,1,1,1,1,,,,,]],[[,,,,,,,,,,,,,,,],[,,,,,,,,,,,,,,,],[,,,,,,,1,1,,,,,,,],[,,,,,,1,1,1,1,,,,,,],[,,,,,1,1,2,2,1,1,,,,,],[,,,,,1,2,2,2,2,1,1,,,,],[,,,,1,1,2,1,2,2,2,1,,,,],[,,,,1,2,2,2,1,2,2,2,1,,,],[,,,1,2,2,2,2,2,2,1,1,2,1,,],[,,1,1,2,2,2,1,2,2,2,2,2,1,,],[,,1,2,2,1,1,2,2,1,2,2,2,2,1],[,1,1,2,2,2,2,2,2,2,1,1,2,2,1],[,1,2,2,2,2,2,1,1,2,2,2,2,2,1],[,1,2,2,1,2,1,2,2,1,2,2,2,2,1],[,,1,2,2,2,2,2,2,2,2,2,2,1,,],[,,1,1,1,1,1,1,1,1,1,1,1,1,,]],[[,,,,,,1,1,1,1,,,,,,],[,,,,,1,2,2,2,2,1,,,,,],[,,,,1,2,2,1,2,2,2,1,,,,],[,,,1,2,2,2,2,2,1,2,1,,,,],[,,1,1,1,2,2,2,2,2,2,1,1,1,,],[,1,2,2,2,1,2,2,2,2,1,2,2,2,1],[,1,2,1,2,2,2,1,2,2,2,2,2,2,1],[,1,2,2,2,1,2,2,2,1,2,2,2,2,1],[,,1,1,1,1,2,1,2,1,1,2,2,1,,],[,,,,,1,2,1,2,1,,1,1,,,],[,,,,,1,2,1,2,1,,,,,,],[,,,,,1,2,2,2,1,,,,,,],[,,,,,1,2,2,2,1,,,,,,],[,,,,1,2,2,1,2,2,1,,,,,],[,,,,1,2,1,2,1,2,1,,,,,],[,,,,1,1,1,1,1,1,1,,,,,]]],vacuum:{size:{x:300,y:500},path:[[70,460],[120,400],[160,445],[195,450,185,380],[225,380],[230,510,145,475]],fill:"#9e9e9e",stroke:"#474747",line:3,box:{pos:{x:150,y:50},size:{x:110,y:330},corner:6,fill:[158,158,158],stroke:{color:[71,71,71],size:2}}}},$.Creator=$.Base.extend({},{getSprites:function(){var a=$.sprites;return{spider:this.generate(a.spider,a.color,!0,3),elements:this.generate(a.elements,a.colors),vacuum:this.drawPath(a.vacuum)}},generate:function(a,b,c,d){var e=new window.Image,f=c?d:a.length,g=document.createElement("canvas"),h=c?a.length:a[0].length,i=c?a[0].length:a[0][0].length,j=2,k=2,l=j*h,m=k*i;g.width=l*f,g.height=m;var n=g.getContext("2d");n.clearRect(0,0,l,m);for(var o=0;f>o;o++)for(var p=0;h>p;p++)for(var q=0;i>q;q++){var r,s,t;c?(r=a[p][q],t=b,s=o+2):(r=a[o][p][q],t=b[o][r],s=o),(c&&(5===r&&(2===s||3===s)||6===r&&(3===s||4===s)||7===r&&(2===s||4===s)||1===r||r===s)||!c&&r)&&(n.save(),n.fillStyle="#"+t,n.fillRect(q*j+l*o,p*k,j,k),n.restore())}return e.src=g.toDataURL("image/png"),g=null,e},drawPath:function(a){var b=new window.Image,c=a.path,d=a.fill,e=a.stroke,f=a.line,g=a.size,h=document.createElement("canvas");h.width=g.x,h.height=g.y;var i=h.getContext("2d");i.beginPath();var j=c[0];i.moveTo(j[0],j[1]);for(var k=1;k<c.length;k++){var l=c[k];4===l.length?i.quadraticCurveTo(l[0],l[1],l[2],l[3]):i.lineTo(l[0],l[1])}return i.lineTo(j[0],j[1]),d&&(i.fillStyle=d,i.fill()),i.lineWidth=f,i.strokeStyle=e,i.lineCap="round",i.stroke(),i.closePath(),$.Renderer.drawRect(i,a.box),b.src=h.toDataURL("image/png"),h=null,b}}),$.Modal=$.Base.extend({start:function(a){this.ctx=a.ctx,this.type=a.type,this.modalItems={},this.initBackDrop(),this["init"+this.type]()},onClick:function(a){this._onClick=a},initBackDrop:function(){this.bg=new $.Rect({pos:{x:0,y:0},size:config.size,corner:10,fill:[0,0,0,.5]})},initmain:function(){var a={x:600,y:500},b=$.V.center($.V.zero,config.size);b.x-=a.x/2,b.y-=a.y/2;var c=this.modalItems.main=[];c.push(new $.Rect({pos:b,size:a,fill:[30,30,30,1],corner:10,stroke:{size:3,color:[255,255,255,1]}}));var d={text:document.title,pos:$.V.center(b,a),size:20};d.pos.x-=d.size*d.text.length*.8/2,d.pos.y=b.y+2*d.size,c.push(new $.Text(d));var e={text:"Use The Elements to lead spiders into the Vacuum!",pos:$.V.center(b,a),size:15};e.pos.x-=e.size*e.text.length*.6/2,e.pos.y=d.pos.y+2.5*e.size+10,c.push(new $.Text(e));var f={x:b.x+30,y:e.pos.y+35};c.push(new $.Elements({pos:f,size:66,gap:15,showKeys:!1}));var g=["BURN","COOL","DIRTY","BLOW"],h=["Burn the web but could kill spiders too!","Fire propagates fast!, use the water to stop it","Stops the fire and won't let spiders re-build the web","Burn faster, annoys spiders and removes dirty"];g.forEach(function(a,b){var d={x:f.x+80,y:80*b+f.y+20};c.push(new $.Text({text:a,pos:d,size:15})),c.push(new $.Text({text:h[b],pos:{x:d.x,y:d.y+25},size:15}))});var i={text:"-- PRESS ENTER --",pos:$.V.center(b,a),size:20,color:[0,255,0,1]};i.pos.x-=i.size*i.text.length*.7/2,i.pos.y=a.y+50,c.push(new $.Text(i))},hide:function(){var a=config.size;this.ctx.clearRect(0,0,a.x,a.y)},show:function(){var a=this.ctx;this.bg.draw(a),this.modalItems[this.type].forEach(function(b){b.draw(a)})}}),$.Manager=$.Base.extend({start:function(){this.cursor=new $.Cursor,this.nodes=new $.Nodes,this.paths=new $.Paths,this.target=new $.Target,this.vacuum=new $.Vacuum({target:this.target}),this.elements=new $.Elements,this.spiders=new $.Spiders({nodes:this.nodes}),this.stats=new $.Stats,this.target.setNodesInside(this.nodes.getNodes())},update:function(){var a=this.cursor,b=this.nodes,c=this.spiders,d=this.elements;a.update(),d.current=a.element,d.active=a.active,c.applyPos=b.applyPos=null,a.active&&(c.applyPos=b.applyPos=a.pos,c.applyRatio=b.applyRatio=a.radius,c.element=b.element=a.element),b.update(),c.update(),this.target.update(c.getSpiders()),this.vacuum.update(),this.stats.update(c.stats),d.update()},draw:function(a,b,c){var d=config.size,e=config.vacuum.size;a.clearRect(0,0,d.x,d.y),b.clearRect(0,0,d.x,d.y),c.clearRect(0,0,e.x,e.y),this.cursor.draw(a),this.nodes.draw(b),this.spiders.draw(b),this.target.draw(b),this.vacuum.draw(c),this.stats.draw(a),this.elements.draw(a)}}),$.GameTime=$.Base.extend({lastTime:null,frameTime:0,deltaTime:0,typicalFrameTime:20,minFrameTime:12,time:0,start:function(){this.lastTime=Date.now()},tick:function(){var a=Date.now(),b=a-this.lastTime;return b<this.minFrameTime?!1:(this.frameTime=b>2*this.typicalFrameTime?this.typicalFrameTime:b,this.deltaTime=this.frameTime/1e3,this.time+=this.frameTime,this.lastTime=a,!0)}}),$.Game=$.Base.extend({viewCtx:null,worldCtx:null,vacuumCtx:null,tLoop:null,paused:!1,start:function(a){this.cview=a.viewport,this.cworld=a.world,this.cvacuum=a.vacuum,this.cmodals=a.modals,this.boundGameRun=this.gameRun.bind(this),this.initContexts(),this.manager=new $.Manager,this.play()},initContexts:function(){function a(a,b){return a.width=b.x,a.height=b.y,a.getContext("2d")}var b=config.size,c=config.vacuum.size;this.viewCtx=a(this.cview,b),this.worldCtx=a(this.cworld,b),this.vacuumCtx=a(this.cvacuum,c),this.modalsCtx=a(this.cmodals,b)},loop:function(){this.manager.update(),this.manager.draw(this.viewCtx,this.worldCtx,this.vacuumCtx)},play:function(){this.paused=!1,Controls.enable(),this.gameRun()},stop:function(){this.paused=!0,Controls.disable(),window.cancelAnimationFrame(this.tLoop)},gameRun:function(){Time.tick()&&this.loop(),this.tLoop=window.requestAnimationFrame(this.boundGameRun)},onWin:function(a){this._onWin=a},onLoose:function(a){this._onLoose=a}}),function(){function a(a){return g.getElementById(a)}function b(a){var b=g.createElement("canvas");return b.id=a,h.appendChild(b),b}function c(){function a(a){var d="offset",e="scroll";return Math.max(b["client"+a],b[e+a],b[d+a],c[e+a],c[d+a])}var b=g.documentElement,c=g.body,d=a("Width")-20,e=a("Height")-30,f={x:1250,y:750},i={x:950,y:640},j={x:d>f.x?f.x:d,y:e>f.y?f.y:e};return j.x=j.x<i.x?i.x:j.x,j.y=j.y<i.y?i.y:j.y,h.style.width=j.x+"px",h.style.height=j.y+"px",{size:j,world:{margin:{x:150,y:20}},vacuum:{size:{x:300,y:500}},elements:["fire","water","earth","air"],methods:["burn","cool","dirty","blow"]}}function d(){function a(){game.paused?game.play():game.stop()}f.Time=new $.GameTime,f.Controls=new $.Controls({container:h}),f.game=new $.Game({viewport:b("viewport"),world:b("world"),vacuum:b("vacuum"),modals:b("modals")}),f.game.onWin(function(){console.log("YOU WIN"),game.stop()
}),f.game.onLoose(function(){console.log("YOU LOOSE"),game.stop()}),f.Controls.on("pause",a)}function e(){f.config=c(),$.repo=$.Creator.getSprites(),d()}var f=window,g=f.document;g.title="SPIDER BUSTERS";var h=a("ctn");f.onload=e}();